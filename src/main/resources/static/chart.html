<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Dynamic Data Graph using Spring and Chart.js</title>
    <style type="text/css">
        BODY {
            width: 2500PX;
            background-color: #303030;
        }

        #chart-container {
            width: 100%;
            height: auto;
        }
    </style>
    <script type="text/javascript" src="/js/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="/js/chart.min.js"></script>


</head>
<body>
<div id="chart-container">
    <canvas id="graphCanvas"></canvas>
</div>

<script>
    let lineGraph;
    let p = [];
    let ma1 = [];
    let ma2 = [];
    let timestamp = [];
    let bids = [];
    let asks = [];

    $(document).ready(function () {
        showGraph();
    });


    function showGraph() {
        {
            $.get("/data",
                function (data) {
                    let tradesData = data.trades;
                    let ordersData = data.orders;

                    console.log(data);

                    for (const i in tradesData) {
                        p.push(tradesData[i].p);
                        ma1.push(tradesData[i].ma1);
                        ma2.push(tradesData[i].ma2);
                        timestamp.push(new Date(Date.parse(tradesData[i].timestamp)).toLocaleTimeString());
                        bids.push(ordersData[i] !== null && ordersData[i].type === 0 ? ordersData[i].averagePrice : null);
                        asks.push(ordersData[i] !== null && ordersData[i].type === 1 ? ordersData[i].averagePrice : null);
                    }

                    const chartdata = {
                        labels: timestamp,
                        datasets: [
                            {
                                label: 'Price',
                                backgroundColor: '#49e2ff',
                                borderColor: '#46d5f1',
                                hoverBackgroundColor: '#CCCCCC',
                                hoverBorderColor: '#666666',
                                borderWidth: 1,
                                pointRadius: 0,
                                data: p.reverse()
                            },
                            {
                                label: 'MA1',
                                backgroundColor: '#5bff49',
                                borderColor: '#3db430',
                                hoverBackgroundColor: '#CCCCCC',
                                hoverBorderColor: '#666666',
                                borderWidth: 1,
                                pointRadius: 0,
                                data: ma1.reverse()
                            },
                            {
                                label: 'MA2',
                                backgroundColor: '#f11919',
                                borderColor: '#a71212',
                                hoverBackgroundColor: '#CCCCCC',
                                hoverBorderColor: '#666666',
                                borderWidth: 1,
                                pointRadius: 0,
                                data: ma2.reverse()
                            },
                            {
                                label: 'Bids',
                                backgroundColor: '#68b131',
                                borderColor: '#000000',
                                hoverBackgroundColor: '#CCCCCC',
                                hoverBorderColor: '#666666',
                                borderWidth: 1,
                                pointRadius: 5,
                                data: bids.reverse()
                            },
                            {
                                label: 'Asks',
                                backgroundColor: '#d91616',
                                borderColor: '#000000',
                                hoverBackgroundColor: '#CCCCCC',
                                hoverBorderColor: '#666666',
                                borderWidth: 1,
                                pointRadius: 5,
                                data: asks.reverse()
                            }
                        ]
                    };

                    const graphTarget = $("#graphCanvas");

                    lineGraph = new Chart(graphTarget, {
                        type: 'line',
                        data: chartdata,
                        options: {
                            animation: {
                                duration: 0
                            }
                        }
                    });
                });
        }
    }

    let chartRefresh = setInterval(function () {
        p = [];
        ma1 = [];
        ma2 = [];
        timestamp = [];
        orders = [];

        try {
            $.get("/data", function (data) {
                let tradesData = data.trades;
                let ordersData = data.orders;

                for (const i in tradesData) {
                    p.push(tradesData[i].p);
                    ma1.push(tradesData[i].ma1);
                    ma2.push(tradesData[i].ma2);
                    bids.push(ordersData[i] !== null && ordersData[i].type === 0 ? ordersData[i].averagePrice : null);
                    asks.push(ordersData[i] !== null && ordersData[i].type === 1 ? ordersData[i].averagePrice : null);
                    timestamp.push(new Date(Date.parse(tradesData[i].timestamp)).toLocaleTimeString());
                }

                lineGraph.data.datasets[0].data = p.reverse();
                lineGraph.data.datasets[1].data = ma1.reverse();
                lineGraph.data.datasets[2].data = ma2.reverse();
                lineGraph.data.datasets[3].data = bids.reverse();
                lineGraph.data.datasets[4].data = asks.reverse();
                lineGraph.data.labels = timestamp.reverse();

                lineGraph.update();
            })
        } catch (e) {
            console.error("Unable to fetch chart data. Stopping.")
            clearInterval(chartRefresh);
        }

        console.log("success");
    }, 1000);
</script>

</body>
</html>